<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Construction Progress Monitoring & Analysis (Plus+)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css">

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<style>
:root{
  --bg:#f3f6f9;
  --card:#ffffff;
  --muted:#6b7280;
  --accent:#2563eb;
  --success:#16a34a;
  --danger:#dc2626;
  --warning:#f59e0b;
  --glass: rgba(255,255,255,0.6);
  --shadow: 0 6px 18px rgba(23,23,23,0.07);
  --radius:12px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Sarabun', Arial, sans-serif;background:linear-gradient(180deg,#f7fafc 0%,var(--bg) 100%);color:#0f172a}
#topbar{
  display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:linear-gradient(90deg,#0f172a, #1f2937);color:#fff;box-shadow:0 4px 18px rgba(2,6,23,0.4);
}
.brand{display:flex;align-items:center;gap:12px;font-weight:700;letter-spacing:0.4px}
.brand img{height:32px; width:auto;}
.top-actions{display:flex;gap:12px;align-items:center;font-size:13px}
.top-meta{background:rgba(255,255,255,0.06);padding:6px 10px;border-radius:8px;display:flex;gap:10px;align-items:center}
.top-meta .dot{width:10px;height:10px;border-radius:50%;background:#10b981}

#projectName {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: #fff;
  padding: 6px 12px;
  border-radius: 6px;
  width: 300px;
  margin-left: 15px;
}

/* Weather Widget */
.weather-widget {
    display: flex; align-items: center; gap: 8px; 
    background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 8px;
    font-size: 13px; color: #e2e8f0; border: 1px solid rgba(255,255,255,0.1);
}

#main{
  display:grid;
  grid-template-columns: 800px 1fr; 
  height:calc(100vh - 64px);
  gap:12px;
  padding: 16px;
  overflow:hidden;
}

#left-panel {
  display: flex;
  flex-direction: column;
  gap: 12px;
  height: 100%;
  overflow-y: auto;
}

#right-panel {
  display: flex;
  flex-direction: column;
  gap: 12px;
  height: 100%;
  overflow-y: auto; 
}

#summaryCard{
  width:100%;
  flex-shrink: 0;
}
.card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);border:1px solid rgba(15,23,42,0.04)}
.card .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.card .title{font-size:15px;font-weight:700}
.card .sub{font-size:12px;color:var(--muted)}

/* Predictive Alert Box */
#predictiveAlertBox {
    background: #fff;
    border-radius: var(--radius);
    padding: 12px;
    box-shadow: var(--shadow);
    border-left: 5px solid #ccc;
    display: none; /* Show when alert active */
    animation: fadeIn 0.5s;
    margin-bottom: 5px;
}
#predictiveAlertBox.alert-danger { border-left-color: var(--danger); background: #fef2f2; }
#predictiveAlertBox.alert-warning { border-left-color: var(--warning); background: #fffbeb; }
.alert-title { font-weight: 700; font-size: 14px; display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
.alert-msg { font-size: 13px; color: #4b5563; line-height: 1.4; }
@keyframes fadeIn { from { opacity:0; transform:translateY(-5px); } to { opacity:1; transform:translateY(0); } }

.tabs-container {
    display: flex;
    gap: 4px;
    background: #e2e8f0;
    padding: 4px 4px 0 4px;
    border-radius: 8px 8px 0 0;
    overflow-x: auto;
    flex-shrink: 0; 
}
.tab {
    padding: 8px 16px;
    background: #cbd5e1;
    border-radius: 6px 6px 0 0;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
    border: none;
}
.tab.active {
    background: var(--card);
    color: var(--accent);
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
}
.tab-actions {
    display: flex;
    gap: 2px;
}
.tab-btn {
    border: none;
    background: none;
    cursor: pointer;
    padding: 2px;
    font-size: 10px;
    opacity: 0.6;
}
.tab-btn:hover { opacity: 1; }

.progress-wrap{margin-bottom:10px}
.progress-label{font-size:13px;margin-bottom:6px;display:flex;justify-content:space-between}
.progress-bar{height:14px;background:#eef2f7;border-radius:999px;overflow:hidden}
.progress-bar span{display:block;height:100%;border-radius:999px}
.bar-actual.ok{background:var(--success)}
.bar-actual.delay{background:var(--danger)}
.bar-plan{background:var(--accent)}

.btn{background:linear-gradient(180deg,#0ea5e9,#2563eb);color:#fff;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;color:var(--muted);border:1px dashed rgba(15,23,42,0.06)}
.btn.warn{background:linear-gradient(180deg,#fb7185,#ef4444)}
.btn.success{background:linear-gradient(180deg,#22c55e,#16a34a)}
.btn.info{background:linear-gradient(180deg,#3b82f6,#2563eb)}
.btn.purple{background:linear-gradient(180deg,#8b5cf6,#7c3aed);}
.btn.dark{background:linear-gradient(180deg,#334155,#0f172a);}

#map{
  width: 100%;
  flex: 1.2;
  min-height: 470px;
  background:#e6eefc;
  border-radius:12px;
  box-shadow:var(--shadow);
  border:1px solid rgba(15,23,42,0.03);
}

#chartContainer {
  height: 250px;
  width: 100%;
}

#bottom{
  background:var(--card);
  border-radius:0 0 var(--radius) var(--radius);
  padding:12px;
  box-shadow:var(--shadow);
  display: flex;
  flex-direction: column;
  flex: 1; 
  min-height: 350px;
}

.analysis-content {
  font-size: 14px;
  line-height: 1.6;
}
.risk-high { color: var(--danger); font-weight: bold; }
.risk-med { color: var(--warning); font-weight: bold; }
.risk-low { color: var(--success); font-weight: bold; }

.table-wrap{
  overflow:auto;
  flex: 1;
}
table{width:100%;border-collapse:collapse;font-size:13px;min-width:100%}
thead th{position:sticky;top:0;background:linear-gradient(180deg,#ffffff,#fafafa);z-index:2;border-bottom:1px solid rgba(15,23,42,0.06);padding:10px 8px;text-align:center}
tbody td{padding:8px 6px;border-bottom:1px solid rgba(15,23,42,0.04);text-align:center}
tr.row-complete{background:linear-gradient(90deg, rgba(34,197,94,0.18), rgba(34,197,94,0.05))}
tr.row-delay{background:linear-gradient(90deg, rgba(239,68,68,0.22), rgba(239,68,68,0.06))}
input[type=number], input[type=date], select, input[type=text]{padding:6px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);min-width:68px}
.icon-btn{background:transparent;border:0;padding:6px;border-radius:8px;cursor:pointer}

.zone-label{background:rgba(2,6,23,0.8);color:#fff;padding:4px 8px;border-radius:8px;font-size:12px}
.input-account { text-align: right; font-variant-numeric: tabular-nums; }

#zoneDetail { 
  flex: none; 
  height: auto; 
  overflow: visible; 
  display: none; 
  margin-top:0;
}

.project-dates-row {
  display: flex; gap: 12px; margin-bottom: 8px; align-items: center;
  background: #f8fafc; padding: 8px; border-radius: 8px; border: 1px solid rgba(15,23,42,0.05);
}
.date-group { display: flex; flex-direction: column; flex: 1; }
.date-group label { font-size: 11px; color: var(--muted); margin-bottom: 2px; font-weight: 600; }

.action-menu-container { position: relative; display: inline-block; }
.action-dropdown {
    display: none; position: absolute; right: 0; top: 100%; background: white;
    min-width: 120px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px;
    z-index: 1000; border: 1px solid #eee;
}
.action-dropdown button {
    display: block; width: 100%; text-align: left; padding: 8px 12px;
    border: none; background: none; font-size: 12px; cursor: pointer;
}
.action-dropdown button.delete-opt { color: var(--danger); }

.photo-item {
  position: relative;
  width: 80px;
  height: 80px;
}
.photo-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 5px;
  cursor: pointer;
  transition: transform 0.2s;
}
.photo-item img:hover {
  transform: scale(1.05);
}
.btn-del-photo {
  position: absolute;
  top: -5px;
  right: -5px;
  background: red;
  color: white;
  border: 1px solid white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 12px;
  line-height: 18px;
  text-align: center;
  cursor: pointer;
  padding: 0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  z-index: 10;
}

#imgModal, .analysis-modal {
  display: none; 
  position: fixed; 
  z-index: 9999; 
  left: 0; 
  top: 0; 
  width: 100%; 
  height: 100%; 
  overflow: auto; 
  background-color: rgba(0,0,0,0.8);
  backdrop-filter: blur(5px);
}
.modal-content {
  margin: auto;
  display: block;
  max-width: 90%;
  max-height: 90vh;
  margin-top: 5vh;
  border-radius: 8px;
  box-shadow: 0 0 20px rgba(255,255,255,0.1);
}
.analysis-modal-content {
  background: white;
  margin: 5% auto;
  padding: 24px;
  width: 700px;
  max-width: 95%;
  border-radius: 12px;
  position: relative;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  max-height: 90vh;
  overflow-y: auto;
}
.analysis-modal-content h3 {
  margin-top: 0;
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--accent);
}
.close-modal {
  position: absolute;
  top: 15px;
  right: 35px;
  color: #f1f1f1;
  font-size: 40px;
  font-weight: bold;
  cursor: pointer;
}
.close-analysis {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 24px;
  cursor: pointer;
  color: #666;
}

/* Compare Modal Styles */
.compare-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}
.compare-col {
    background: #f8fafc;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}
.stat-box {
    text-align: center;
    margin: 10px 0;
}
.stat-value {
    font-size: 24px;
    font-weight: bold;
    color: var(--accent);
}
.diff-val.positive { color: var(--success); }
.diff-val.negative { color: var(--danger); }
.compare-table-wrap {
    margin-top: 15px;
    border-top: 1px solid #e2e8f0;
    padding-top: 10px;
}
.photo-grid-small {
    display: flex; gap: 4px; overflow-x: auto; padding: 4px 0;
}
.photo-grid-small img {
    width: 40px; height: 40px; border-radius: 4px; object-fit: cover; cursor: pointer; border: 1px solid #ddd;
}
.new-badge {
    font-size: 10px; background: var(--success); color: white; padding: 2px 4px; border-radius: 4px; display: inline-block;
}

/* Print Container for PDF Generation */
#pdf-print-container {
    position: absolute; left: -9999px; top: 0; width: 800px;
    background: white; padding: 40px; font-family: 'Sarabun', sans-serif;
}

/* Loading Overlay for Online Sync */
#loadingOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255,255,255,0.9); z-index: 10000;
    display: flex; justify-content: center; align-items: center;
    flex-direction: column;
}
.spinner {
    width: 40px; height: 40px; border: 4px solid #e2e8f0;
    border-top: 4px solid var(--accent); border-radius: 50%;
    animation: spin 1s linear infinite; margin-bottom: 10px;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

@media (max-width:1100px){
  #main{grid-template-columns:1fr; overflow-y: auto; display: block;}
  #left-panel, #right-panel { height: auto; }
  #map { height: 500px; }
  .analysis-modal-content { width: 95%; }
  .compare-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="font-weight:600;color:#334155">Connecting to Cloud...</div>
</div>

<div id="topbar">
  <div class="brand">
    <img src="https://cm49.co.th/resources/images/logo-cm49.png" alt="CM49 Logo">
    <span>Construction Progress Monitoring (Online)</span>
    <input id="projectName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Project Name)" onblur="saveProjectMeta()">
  </div>
  <div class="top-actions">
    <div class="weather-widget" id="topWeatherWidget">
        <span id="weatherIcon">‚òÅÔ∏è</span>
        <span id="weatherTemp">--¬∞C</span>
    </div>

    <button class="btn purple" onclick="exportDailyReportPDF()" style="padding: 4px 10px; font-size: 12px;">üìÑ Daily PDF</button>
    <button class="btn success" onclick="exportExcel()" style="padding: 4px 10px; font-size: 12px;">Export Excel</button>
    <div class="top-meta"><div class="dot"></div><div id="autosave">Cloud Sync</div></div>
    <div id="currentTime" class="sub">Current : -</div>
  </div>
</div>

<div id="main">
  <div id="left-panel">
    <div class="project-dates-row">
      <div class="date-group">
        <label>Project Start Date</label>
        <input type="date" id="projectStartDate" onchange="saveProjectDates();">
      </div>
      <div class="date-group">
        <label>Project Due Date</label>
        <input type="date" id="projectEndDate" onchange="saveProjectDates();">
      </div>
      <div style="font-size:12px;color:var(--muted);align-self:end;padding-bottom:4px">
        Overall Value: <strong id="totalProjectValue">0.00</strong> THB
      </div>
    </div>

    <div class="card" style="padding:10px;">
      <div class="card-header" style="margin-bottom:0">
        <div class="title">Overall S-Curve Analysis</div>
        <div style="display: flex; gap: 5px;">
           <select id="forecastMethodSelector" onchange="updateSummary()" style="font-size: 11px; padding: 2px; border-radius: 4px;">
              <option value="bottomup">Bottom-Up Forecasting</option>
              <option value="evm">Earned Value Management (EVM)</option>
              <option value="optimistic">Scenario: Optimistic</option>
              <option value="mostlikely">Scenario: Most Likely</option>
              <option value="pessimistic">Scenario: Pessimistic</option>
           </select>
           <button class="btn info" onclick="openAnalysisModal('forecastModal')" style="padding: 2px 8px; font-size: 11px;">üìà Forecast</button>
           <button class="btn info" onclick="openAnalysisModal('riskModal')" style="padding: 2px 8px; font-size: 11px;">‚ö†Ô∏è Risk</button>
           <button class="btn dark" onclick="openCompareModal()" style="padding: 2px 8px; font-size: 11px;">üÜö Compare</button>
           <button class="btn warn" onclick="clearDailyHistory()" style="padding: 2px 8px; font-size: 11px;">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
      </div>
      <div id="chartContainer">
        <canvas id="sCurveChart"></canvas>
      </div>
    </div>
    
    <div id="map" class="card"></div>
  </div> 

  <div id="right-panel">
    
    <div id="predictiveAlertBox">
        <div class="alert-title" id="predTitle"></div>
        <div class="alert-msg" id="predMsg"></div>
    </div>

    <div id="summaryCard" class="card">
      <div class="card-header">
        <div>
          <div class="title">Overall Project Summary</div>
          <div class="sub">Weighted Average across all Tabs</div>
        </div>
        <div id="summaryStatus" class="sub" style="font-weight: 700; font-size: 14px;">‚Äì</div>
      </div>
      <div class="progress-wrap">
        <div class="progress-label"><span>Actual Progress</span><strong id="sumActual">0.00%</strong></div>
        <div class="progress-bar"><span id="barActual" class="bar-actual ok" style="width:0%"></span></div>
      </div>
      <div class="progress-wrap">
        <div class="progress-label"><span>Plan Progress</span><strong id="sumPlan">0.00%</strong></div>
        <div class="progress-bar"><span id="barPlan" class="bar-plan" style="width:0%"></span></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:13px">
        <div>Total Zones (All): <strong id="sumZones">0</strong></div>
        <div id="summaryVarianceDays" style="font-weight: 600;"></div>
      </div>
    </div>

    <div class="tabs-container" id="tabsContainer"></div>

    <div id="bottom" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-shrink:0;">
        <div style="display:flex;align-items:center;gap:15px; width: 100%;">
           <div class="history-panel-embedded">
             <strong>Update:</strong>
             <input type="date" id="historyDateSelector">
             <button class="btn success" onclick="saveDailyProgress()" style="padding: 2px 8px; font-size: 11px;">Save Progress</button>
             <span id="historyStatus" style="color:var(--success); font-weight:600; font-size: 11px;"></span>
           </div>
           
           <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
              <div id="layoutName" class="layout-preview" style="font-size:11px; max-width:150px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">No Layout</div>
              <label id="btnSelectLayout" class="btn" for="uploadPlan" style="padding:4px 8px; font-size:11px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Layout</label>
              <button id="btnDeleteLayout" class="btn warn" onclick="removePlan()" style="display:none; padding:4px 8px; font-size:11px;">‡∏•‡∏ö layout</button>
              <input type="file" id="uploadPlan" accept="image/*" style="display:none">
           </div>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:40px">#</th>
              <th style="min-width:100px">Name</th>
              <th style="width:120px">Cost (THB)</th> 
              <th style="width:110px">Status</th>
              <th style="width:70px">Actual%</th>
              <th style="width:70px">Plan%</th>
              <th style="width:50px">Start</th>
              <th style="width:50px">Due</th>
              <th style="width:90px">Delay</th>
              <th style="width:80px">Photo</th>
              <th style="width:50px">Action</th>
            </tr>
          </thead>
          <tbody id="zoneTable"></tbody>
        </table>
      </div>
    </div>

    <div id="zoneDetail" class="card">
      <div class="card-header">
        <div><div class="title" id="zdName">Zone Detail</div><div class="sub" id="zdStatus">‚Äì</div></div>
        <button class="icon-btn" onclick="closeZoneDetail()" style="font-size: 18px;">‚ûñ</button>
      </div>
      <div style="font-size:13px;margin-bottom:8px">
        <div><strong>Progress:</strong> <span id="zdProgress">-</span></div>
        <div><strong>Due Date:</strong> <span id="zdDue">-</span></div>
        <div><strong>Cost:</strong> <span id="zdCost">-</span> THB</div>
      </div>
      <div id="zdPhotos" style="display:grid;grid-template-columns:repeat(auto-fill,80px);gap:8px"></div>
    </div>
  </div> 
</div>

<div id="forecastModal" class="analysis-modal">
  <div class="analysis-modal-content">
    <span class="close-analysis" onclick="closeAnalysisModal('forecastModal')">&times;</span>
    <h3><span>üìà</span> Forecast Details</h3>
    <hr>
    <div id="forecastContent" class="analysis-content">‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</div>
  </div>
</div>

<div id="riskModal" class="analysis-modal">
  <div class="analysis-modal-content">
    <span class="close-analysis" onclick="closeAnalysisModal('riskModal')">&times;</span>
    <h3><span>‚ö†Ô∏è</span> Risk Analysis</h3>
    <hr>
    <div id="riskContent" class="analysis-content">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>
</div>

<div id="compareModal" class="analysis-modal">
    <div class="analysis-modal-content" style="width:900px;">
        <span class="close-analysis" onclick="closeAnalysisModal('compareModal')">&times;</span>
        <h3><span>üÜö</span> Snapshot Comparison Dashboard</h3>
        <hr>
        <div style="display:flex; gap:20px; align-items:center; margin-bottom:15px; background:#eee; padding:10px; border-radius:8px;">
            <div style="flex:1;">
                <label style="font-size:12px; font-weight:bold;">Snapshot A (Previous):</label>
                <select id="compareDateA" onchange="renderComparison()" style="width:100%"></select>
            </div>
            <div style="font-size:24px; color:#64748b;">‚û°Ô∏è</div>
            <div style="flex:1;">
                <label style="font-size:12px; font-weight:bold;">Snapshot B (Target/Current):</label>
                <select id="compareDateB" onchange="renderComparison()" style="width:100%"></select>
            </div>
        </div>

        <div class="compare-grid">
            <div class="compare-col" id="compareColA">
                <div style="text-align:center; font-weight:bold; margin-bottom:10px;">Snapshot A</div>
                <div class="stat-box">
                    <div style="font-size:12px; color:#64748b;">Total Progress</div>
                    <div class="stat-value" id="compValA">0.00%</div>
                </div>
                <div style="text-align:center; font-size:12px;" id="compWeatherA"></div>
            </div>
            <div class="compare-col" id="compareColB">
                <div style="text-align:center; font-weight:bold; margin-bottom:10px;">Snapshot B</div>
                <div class="stat-box">
                    <div style="font-size:12px; color:#64748b;">Total Progress</div>
                    <div class="stat-value" id="compValB">0.00%</div>
                </div>
                <div style="text-align:center; font-size:12px;" id="compWeatherB"></div>
            </div>
        </div>

        <h4 style="margin:10px 0 5px;">Zone Breakdown & Visual Changes</h4>
        <div class="table-wrap" style="max-height:300px;">
            <table style="font-size:12px;">
                <thead>
                    <tr style="background:#f1f5f9;">
                        <th>Zone Name</th>
                        <th style="width:80px;">Old %</th>
                        <th style="width:80px;">New %</th>
                        <th style="width:80px;">Diff</th>
                        <th>Photos (During Period)</th>
                    </tr>
                </thead>
                <tbody id="compareTableBody">
                    <tr><td colspan="5" style="text-align:center;">Select dates to compare</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="imgModal" onclick="this.style.display='none'">
  <span class="close-modal">&times;</span>
  <img class="modal-content" id="imgModalSrc">
</div>

<div id="pdf-print-container">
    <div style="display:flex; justify-content:space-between; border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:20px;">
        <div>
            <img src="https://cm49.co.th/resources/images/logo-cm49.png" style="height:40px;">
            <h2 style="margin:5px 0 0 0; color:#0f172a;" id="pdf-project-name">Project Name</h2>
        </div>
        <div style="text-align:right;">
            <div style="font-size:24px; font-weight:bold; color:#2563eb;">DAILY REPORT</div>
            <div id="pdf-date" style="font-size:14px;">Date: -</div>
            <div id="pdf-weather" style="font-size:14px; margin-top:4px;">Weather: -</div>
        </div>
    </div>

    <div style="background:#f1f5f9; padding:15px; border-radius:8px; margin-bottom:20px; display:flex; justify-content:space-around;">
        <div style="text-align:center;">
            <div style="font-size:12px; color:#64748b;">Plan Progress</div>
            <div id="pdf-plan" style="font-size:20px; font-weight:bold; color:#2563eb;">0.00%</div>
        </div>
        <div style="text-align:center;">
            <div style="font-size:12px; color:#64748b;">Actual Progress</div>
            <div id="pdf-actual" style="font-size:20px; font-weight:bold; color:#16a34a;">0.00%</div>
        </div>
        <div style="text-align:center;">
            <div style="font-size:12px; color:#64748b;">Status</div>
            <div id="pdf-status" style="font-size:20px; font-weight:bold;">-</div>
        </div>
    </div>

    <h3 style="border-bottom:1px solid #ddd; padding-bottom:5px;">Work Progress</h3>
    <table style="width:100%; border-collapse: collapse; font-size:12px;">
        <thead>
            <tr style="background:#e2e8f0; text-align:left;">
                <th style="padding:8px; border:1px solid #cbd5e1;">Zone / Area</th>
                <th style="padding:8px; border:1px solid #cbd5e1;">Status</th>
                <th style="padding:8px; border:1px solid #cbd5e1;">Progress</th>
                <th style="padding:8px; border:1px solid #cbd5e1;">Note</th>
            </tr>
        </thead>
        <tbody id="pdf-table-body">
            </tbody>
    </table>
    
    <div style="margin-top:30px; font-size:10px; color:#94a3b8; text-align:center;">
        Generated by CM49 Construction Monitoring System
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
// --- FIREBASE CONFIGURATION (REPLACE WITH YOUR KEYS) ---
const firebaseConfig = {
  apiKey: "AIzaSyADToM3OMPpyuOfLg4cvaG6yVu39mF27ck",
  authDomain: "construction-monitor-cm49.firebaseapp.com",
  databaseURL: "https://construction-monitor-cm49-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "construction-monitor-cm49",
  storageBucket: "construction-monitor-cm49.firebasestorage.app",
  messagingSenderId: "657060218730",
  appId: "1:657060218730:web:2098de5ce592f3d9860713",
  measurementId: "G-RGWTQZ0EJV"
};

// Initialize Firebase
let db = null;
let storage = null;
let dbRef = null;

try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    storage = firebase.storage();
    dbRef = db.ref('cm49_project_v1'); // Root Node
} catch (e) {
    console.error("Firebase Init Error:", e);
    alert("Firebase Configuration is missing or incorrect. Please edit the code to add your API keys.");
}

// Global Application State
let workspaces = [];
let activeWorkspaceId = 'default';
let dailyHistory = {};
let selectedZoneId = null;
let myChart = null;
let imageOverlay = null;
let currentWeather = { temp: '-', code: -1, desc: 'Unknown' };

const map = L.map('map', { crs: L.CRS.Simple, minZoom: -2 });
const mapBounds = [[0, 0], [1000, 1000]];
map.fitBounds(mapBounds);
map.pm.addControls({ drawPolygon: true, editMode: true, removalMode: true, position: 'topleft' });

function openAnalysisModal(id) { document.getElementById(id).style.display = "block"; }
function closeAnalysisModal(id) { document.getElementById(id).style.display = "none"; }

// --- Firebase Data Sync Functions ---

async function initFirebase() {
    document.getElementById('loadingOverlay').style.display = 'flex';
    if(!dbRef) return;
    
    // Listen for data changes
    dbRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            // Load Project Meta
            document.getElementById('projectName').value = data.projectName || '';
            document.getElementById('projectStartDate').value = data.projectStartDate || '';
            document.getElementById('projectEndDate').value = data.projectEndDate || '';

            // Load Workspaces
            if (data.workspaces) {
                workspaces = JSON.parse(data.workspaces);
            } else {
                workspaces = [{ id: 'default', name: 'Main Floor', zones: [], layout: null, layoutName: 'No Layout' }];
            }

            // Load History
            if (data.dailyHistory) {
                dailyHistory = JSON.parse(data.dailyHistory);
            } else {
                dailyHistory = {};
            }

            // Load Active ID
            activeWorkspaceId = data.activeWorkspaceId || workspaces[0].id;

            initUI();
            updateSummary(); // Recalc logic
        } else {
            // First time run
            workspaces = [{ id: 'default', name: 'Main Floor', zones: [], layout: null, layoutName: 'No Layout' }];
            saveAll();
            initUI();
        }
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('autosave').innerText = "Cloud Sync";
    }, (error) => {
        console.error("Read failed", error);
        document.getElementById('loadingOverlay').innerHTML = `<div style="color:red">Connection Failed</div>`;
    });
}

function saveAll() {
    if(!dbRef) return;
    
    const dataToSave = {
        projectName: document.getElementById('projectName').value,
        projectStartDate: document.getElementById('projectStartDate').value,
        projectEndDate: document.getElementById('projectEndDate').value,
        workspaces: JSON.stringify(workspaces),
        activeWorkspaceId: activeWorkspaceId,
        dailyHistory: JSON.stringify(dailyHistory),
        lastUpdated: new Date().toISOString()
    };

    dbRef.update(dataToSave).then(() => {
        document.getElementById('autosave').innerText = "Saved (Cloud)";
        setTimeout(() => { document.getElementById('autosave').innerText = "Cloud Sync"; }, 2000);
    }).catch(e => {
        document.getElementById('autosave').innerText = "Save Error!";
        console.error(e);
    });
}

function saveProjectMeta() { saveAll(); }
function saveProjectDates() { saveAll(); updateSummary(); }

// --- Firebase Storage Helper ---

const storageHelper = {
    async uploadImage(base64, path) {
        if(!storage) return null;
        const ref = storage.ref().child(path);
        // Convert Base64 to Blob
        const response = await fetch(base64);
        const blob = await response.blob();
        await ref.put(blob);
        const url = await ref.getDownloadURL();
        return url;
    },
    async deleteImage(url) {
        if(!storage || !url.startsWith('http')) return;
        try {
            const ref = storage.refFromURL(url);
            await ref.delete();
        } catch(e) {
            console.warn("Delete image error (might not exist):", e);
        }
    }
};

function compressImage(base64, maxWidth = 800, quality = 0.5) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.src = base64;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > maxWidth) { h = (maxWidth / w) * h; w = maxWidth; }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/jpeg', quality));
        };
        img.onerror = reject;
    });
}

// --- UI & Logic Functions ---

function renderTabs() {
    const container = document.getElementById('tabsContainer');
    container.innerHTML = '';
    workspaces.forEach(ws => {
        const tab = document.createElement('button');
        tab.className = `tab ${ws.id === activeWorkspaceId ? 'active' : ''}`;
        tab.onclick = () => switchWorkspace(ws.id);
        tab.innerHTML = `
            <span>${ws.name}</span>
            <div class="tab-actions">
                <span class="tab-btn" onclick="event.stopPropagation(); promptRename('${ws.id}')">‚úèÔ∏è</span>
                ${workspaces.length > 1 ? `<span class="tab-btn" onclick="event.stopPropagation(); deleteWorkspace('${ws.id}')">‚úï</span>` : ''}
            </div>
        `;
        container.appendChild(tab);
    });
    const addBtn = document.createElement('button');
    addBtn.className = 'tab';
    addBtn.style.background = '#22c55e';
    addBtn.style.color = '#fff';
    addBtn.innerText = '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏µ‡∏ó‡πÉ‡∏´‡∏°‡πà';
    addBtn.onclick = addWorkspace;
    container.appendChild(addBtn);
}

function addWorkspace() {
    const name = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà:", "‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà");
    if (!name) return;
    const newId = 'ws_' + Date.now();
    workspaces.push({ id: newId, name: name, zones: [], layout: null, layoutName: 'No Layout' });
    activeWorkspaceId = newId;
    saveAll();
    // No need to call initUI, listener will trigger
}

function switchWorkspace(id) {
    activeWorkspaceId = id;
    closeZoneDetail();
    saveAll();
    // Listener will trigger update
}

async function deleteWorkspace(id) {
    if (!confirm("‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")) return;
    const ws = workspaces.find(w => w.id === id);
    if(ws) {
        if(ws.layout && ws.layout.startsWith('http')) await storageHelper.deleteImage(ws.layout);
        ws.zones.forEach(z => {
            if(z.photos && z.photos.length) {
                z.photos.forEach(async pid => {
                    if(pid.startsWith('http')) await storageHelper.deleteImage(pid);
                });
            }
        });
    }
    workspaces = workspaces.filter(ws => ws.id !== id);
    if (activeWorkspaceId === id) activeWorkspaceId = workspaces[0].id;
    saveAll();
}

function promptRename(id) {
    const ws = workspaces.find(w => w.id === id);
    const newName = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡πÉ‡∏´‡∏°‡πà:", ws.name);
    if (newName) { ws.name = newName; saveAll(); }
}

function getActiveWS() {
    return workspaces.find(ws => ws.id === activeWorkspaceId);
}

async function initLayout() {
    const ws = getActiveWS();
    if(!ws) return; // Guard

    map.eachLayer(layer => {
        if (layer instanceof L.GeoJSON || layer instanceof L.Marker || layer instanceof L.Polygon || layer instanceof L.ImageOverlay) {
            map.removeLayer(layer);
        }
    });
    imageOverlay = null;

    if (ws.layout) {
        // Direct URL usage for Firebase Storage
        imageOverlay = L.imageOverlay(ws.layout, mapBounds).addTo(map);
        document.getElementById("layoutName").innerText = ws.layoutName;
        document.getElementById('btnSelectLayout').style.display = 'none';
        document.getElementById('btnDeleteLayout').style.display = 'inline-block';
    } else {
        document.getElementById("layoutName").innerText = 'No Layout';
        document.getElementById('btnSelectLayout').style.display = 'inline-block';
        document.getElementById('btnDeleteLayout').style.display = 'none';
    }
}

document.getElementById('uploadPlan').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // UI Feedback
    const btn = document.getElementById('btnSelectLayout');
    const oldText = btn.innerText;
    btn.innerText = "Uploading...";
    
    const reader = new FileReader();
    reader.onload = async (event) => {
        try {
            const compressed = await compressImage(event.target.result, 1500, 0.7);
            const ws = getActiveWS();
            const fileName = `layout_${ws.id}_${Date.now()}.jpg`;
            const url = await storageHelper.uploadImage(compressed, 'layouts/' + fileName);
            
            ws.layout = url;
            ws.layoutName = file.name;
            saveAll();
        } catch(err) {
            console.error(err);
            alert("Upload failed");
        } finally {
            btn.innerText = oldText;
            document.getElementById('uploadPlan').value = '';
        }
    };
    reader.readAsDataURL(file);
});

async function removePlan() {
    if (!confirm("‡∏•‡∏ö Layout?")) return;
    const ws = getActiveWS();
    if(ws.layout && ws.layout.startsWith('http')) await storageHelper.deleteImage(ws.layout);
    ws.layout = null;
    ws.layoutName = 'No Layout';
    saveAll();
}

map.on('pm:create', e => {
    const name = prompt("‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠ Zone:");
    if (!name) { map.removeLayer(e.layer); return; }
    const ws = getActiveWS();
    ws.zones.push({
        id: Date.now(), name, status: "Not Started", progress: 0, cost: 0,
        startDate: new Date().toISOString().slice(0, 10), dueDate: "", 
        geojson: e.layer.toGeoJSON(), photos: []
    });
    saveAll();
});

function loadZones() {
    // Clear existing (except tiles/image) handled in initLayout somewhat, but let's be safe
    // Note: initLayout clears everything, so loadZones adds back polygons
    const ws = getActiveWS();
    if(!ws) return;

    ws.zones.forEach(z => {
        const planP = calcPlan(z);
        const color = z.progress >= 100 ? '#16a34a' : (z.progress < planP ? '#dc2626' : '#2563eb');
        const l = L.geoJSON(z.geojson, { style: { color, weight: 2, fillOpacity: 0.2 } }).addTo(map);
        l.bindTooltip(z.name, { permanent: true, direction: "center", className: "zone-label" });
    });
    renderTable();
    updateSummary();
}

function calcPlan(z) {
    if (!z.startDate || !z.dueDate) return 0;
    const s = new Date(z.startDate), d = new Date(z.dueDate), n = new Date();
    if (isNaN(s) || isNaN(d) || d <= s || n <= s) return 0;
    if (n >= d) return 100;
    return parseFloat(((n - s) / (d - s) * 100).toFixed(2));
}

function updateSummary() {
    let totalCost = 0, wSumA = 0, wSumP = 0, totalZonesCount = 0;
    workspaces.forEach(ws => {
        ws.zones.forEach(z => {
            const c = parseFloat(z.cost) || 0;
            totalCost += c;
            wSumA += ((parseFloat(z.progress) || 0) * c);
            wSumP += (calcPlan(z) * c);
            totalZonesCount++;
        });
    });
    const act = totalCost > 0 ? (wSumA / totalCost) : 0;
    const pln = totalCost > 0 ? (wSumP / totalCost) : 0;

    document.getElementById('totalProjectValue').innerText = totalCost.toLocaleString(undefined, { minimumFractionDigits: 2 });
    document.getElementById('sumZones').innerText = totalZonesCount;
    document.getElementById('sumActual').innerText = act.toFixed(2) + "%";
    document.getElementById('sumPlan').innerText = pln.toFixed(2) + "%";
    document.getElementById('barActual').style.width = act + "%";
    document.getElementById('barPlan').style.width = pln + "%";

    const isDelay = act < pln;
    document.getElementById('barActual').style.backgroundColor = isDelay ? 'var(--danger)' : 'var(--success)';
    document.getElementById('summaryStatus').innerHTML = isDelay ? '<span style="color:var(--danger)">üî¥ Delay</span>' : '<span style="color:var(--success)">üü¢ On Track</span>';

    // Call Predictive Analysis
    checkPredictiveRisks(act, pln, totalCost);
    updateSCurve(totalCost, isDelay ? '#dc2626' : '#16a34a', act, pln);
}

// --- New Feature: Predictive Alert System ---
function checkPredictiveRisks(currentAct, currentPln, totalCost) {
    const alertBox = document.getElementById('predictiveAlertBox');
    const startVal = document.getElementById('projectStartDate').value;
    const endVal = document.getElementById('projectEndDate').value;
    
    if (!startVal || !endVal || totalCost === 0) {
        alertBox.style.display = 'none';
        return;
    }

    const today = new Date();
    const end = new Date(endVal);
    const start = new Date(startVal);
    // const totalDays = (end - start) / 86400000;
    const daysRemaining = (end - today) / 86400000;
    
    if (daysRemaining <= 0) return; // Project over

    const remainingProgress = 100 - currentAct;
    const requiredVelocity = remainingProgress / daysRemaining; // % per day needed

    // Calculate Current Velocity (Average of last 7 days or overall if < 7 days)
    // For simplicity in this structure, we use overall velocity:
    const daysPassed = (today - start) / 86400000;
    const currentVelocity = daysPassed > 0 ? currentAct / daysPassed : 0;

    let alertHtml = '';
    let alertClass = '';

    // Condition 1: Impossible Catchup (Required Speed is > 2x Current Speed)
    if (requiredVelocity > (currentVelocity * 2) && currentVelocity > 0) {
        alertClass = 'alert-danger';
        alertHtml = `
            <div class="alert-title"><span style="font-size:18px">üö®</span> High Risk: Critical Velocity Warning</div>
            <div class="alert-msg">
                ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (${currentVelocity.toFixed(2)}%/‡∏ß‡∏±‡∏ô) ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠!<br>
                ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô <strong>${requiredVelocity.toFixed(2)}%/‡∏ß‡∏±‡∏ô</strong> (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ${(requiredVelocity/currentVelocity).toFixed(1)} ‡πÄ‡∏ó‡πà‡∏≤) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£
            </div>
        `;
    }
    // Condition 2: Trending Down (Delay gap is widening) - Simple check if gap > 10%
    else if ((currentPln - currentAct) > 10) {
        alertClass = 'alert-warning';
        alertHtml = `
            <div class="alert-title"><span style="font-size:18px">‚ö†Ô∏è</span> Predictive Warning: Gap Widening</div>
            <div class="alert-msg">
                ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡∏™‡∏∞‡∏™‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏Å‡∏§‡∏ï (Gap > 10%) ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏≤‡∏ü S-Curve ‡∏à‡∏∞‡∏î‡∏¥‡πà‡∏á‡∏•‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å 7 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤
            </div>
        `;
    }

    if (alertHtml) {
        alertBox.className = alertClass;
        document.getElementById('predTitle').innerHTML = alertHtml.match(/<div class="alert-title">(.*?)<\/div>/)[1];
        document.getElementById('predMsg').innerHTML = alertHtml.match(/<div class="alert-msg">([\s\S]*?)<\/div>/)[1];
        alertBox.style.display = 'block';
    } else {
        alertBox.style.display = 'none';
    }
}

function renderTable() {
    const ws = getActiveWS();
    const tb = document.getElementById("zoneTable");
    tb.innerHTML = "";
    ws.zones.forEach((z, i) => {
        const plan = calcPlan(z);
        const isDelay = z.progress < plan;
        const cls = z.progress >= 100 ? "row-complete" : (isDelay ? "row-delay" : "");
        tb.innerHTML += `
            <tr class="${cls}" onclick="selectZone(${z.id})">
                <td>${i + 1}</td>
                <td style="text-align:left">${z.name}</td>
                <td><input type="text" class="input-account" value="${(z.cost || 0).toLocaleString(undefined, { minimumFractionDigits: 2 })}" 
                    style="width:100px" onclick="event.stopPropagation()" onblur="updateZoneCost(${z.id}, this.value)"></td>
                <td><select onchange="updateZoneStatus(${z.id}, this.value)" onclick="event.stopPropagation()">
                    <option ${z.status === "Not Started" ? "selected" : ""}>Not Started</option>
                    <option ${z.status === "In Progress" ? "selected" : ""}>In Progress</option>
                    <option ${z.status === "Completed" ? "selected" : ""}>Completed</option>
                </select></td>
                <td><input type="number" value="${z.progress}" style="width:60px" onclick="event.stopPropagation()" onchange="updateZoneProgress(${z.id}, this.value)"></td>
                <td>${plan}%</td>
                <td><input type="date" value="${z.startDate}" onclick="event.stopPropagation()" onchange="updateZoneDate(${z.id}, 'startDate', this.value)"></td>
                <td><input type="date" value="${z.dueDate}" onclick="event.stopPropagation()" onchange="updateZoneDate(${z.id}, 'dueDate', this.value)"></td>
                <td>${isDelay ? "üî¥ Delay" : "üü¢ OK"}</td>
                <td><button class="btn ghost" style="padding:2px 5px" onclick="event.stopPropagation(); triggerPhoto(${z.id})">üì∑ ${z.photos ? z.photos.length : 0}</button></td>
                <td>
                    <div class="action-menu-container">
                        <button class="icon-btn" onclick="toggleActionMenu(event, ${z.id})">‚öôÔ∏è</button>
                        <div class="action-dropdown" id="menu-${z.id}">
                            <button onclick="renameZone(${z.id})">‚úèÔ∏è Rename</button>
                            <button class="delete-opt" onclick="deleteZone(${z.id})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                </td>
            </tr>`;
    });
}

function updateSCurve(totalCost, actualColor, currentAct, currentPln) {
    const ctx = document.getElementById('sCurveChart').getContext('2d');
    const startVal = document.getElementById('projectStartDate').value;
    const endVal = document.getElementById('projectEndDate').value;
    const method = document.getElementById('forecastMethodSelector').value;
    
    if(!startVal || !endVal) {
        document.getElementById('forecastContent').innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£...";
        return;
    }

    const start = new Date(startVal), end = new Date(endVal);
    const today = new Date();
    const sortedDates = Object.keys(dailyHistory).sort();
    const lastActualDate = sortedDates.length ? new Date(sortedDates[sortedDates.length-1]) : new Date(today.toISOString().slice(0,10));

    const labels = [];
    const planData = [];
    const actualData = [];
    const forecastData = [];

    const zoneStats = [];
    workspaces.forEach(ws => ws.zones.forEach(z => {
        const cost = parseFloat(z.cost) || 0;
        const zStart = new Date(z.startDate);
        const zDue = new Date(z.dueDate);
        const zProgress = parseFloat(z.progress) || 0;
        let vel = 0;
        if (zProgress > 0) {
            const days = (today - zStart) / 86400000;
            vel = days > 0 ? zProgress / days : 0;
        } else if (zStart && zDue) {
            vel = 100 / ((zDue - zStart) / 86400000);
        }
        zoneStats.push({ cost, zStart, zDue, zProgress, vel });
    }));

    const spi = currentPln > 0 ? currentAct / currentPln : 1;

    let curr = new Date(start);
    let forecastFinished = false;
    let maxDate = new Date(end.getTime() + 365 * 24 * 60 * 60 * 1000);

    while (curr <= maxDate) {
        const dStr = curr.toISOString().slice(0,10);
        labels.push(dStr);

        let wPlan = 0;
        workspaces.forEach(ws => ws.zones.forEach(z => {
            const zc = parseFloat(z.cost) || 0;
            const zs = new Date(z.startDate), zd = new Date(z.dueDate);
            let pct = curr >= zd ? 1 : (curr <= zs ? 0 : (curr - zs)/(zd - zs));
            wPlan += (pct * zc);
        }));
        planData.push(totalCost > 0 ? (wPlan/totalCost*100).toFixed(2) : 0);

        if (curr <= lastActualDate) {
            if (dailyHistory[dStr]) {
                let wAct = 0;
                // Support old format (simple object) and new format (with weather)
                const snapshot = dailyHistory[dStr].data ? dailyHistory[dStr].data : dailyHistory[dStr];
                
                workspaces.forEach(ws => ws.zones.forEach(z => {
                    wAct += ((snapshot[z.id] || 0) * (parseFloat(z.cost) || 0));
                }));
                actualData.push(totalCost > 0 ? (wAct/totalCost*100).toFixed(2) : 0);
            } else {
                actualData.push(actualData.length ? actualData[actualData.length-1] : "0.00");
            }
            forecastData.push(null);
        } else {
            actualData.push(null);
            let fVal = 0;
            const daysFromToday = (curr - today) / 86400000;

            if (method === 'bottomup') {
                let wSum = 0;
                zoneStats.forEach(s => {
                    let p = s.zProgress + (s.vel * daysFromToday);
                    wSum += (Math.max(0, Math.min(100, p)) * s.cost);
                });
                fVal = totalCost > 0 ? (wSum/totalCost) : 0;
            } else if (method === 'evm') {
                const plannedVelocityDaily = (100 - currentAct) / ((end - today) / 86400000);
                fVal = currentAct + (plannedVelocityDaily * spi * daysFromToday);
            } else if (method === 'optimistic') {
                fVal = currentAct + ((100 - currentAct) / ((end - today) / 86400000) * 1.2 * daysFromToday);
            } else if (method === 'pessimistic') {
                fVal = currentAct + ((100 - currentAct) / ((end - today) / 86400000) * 0.7 * daysFromToday);
            } else { 
                fVal = currentAct + ((100 - currentAct) / ((end - today) / 86400000) * 1.0 * daysFromToday);
            }

            fVal = Math.min(100, Math.max(0, fVal));
            forecastData.push(fVal.toFixed(2));
            if (fVal >= 100 && curr >= end) forecastFinished = true;
        }

        if (forecastFinished) break;
        curr.setDate(curr.getDate() + 1);
    }

    if(myChart) myChart.destroy();
    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [
                {label:'Plan %', data:planData, borderColor:'#2563eb', pointRadius:0, tension:0.1},
                {label:'Actual %', data:actualData, borderColor:actualColor, pointRadius:0, tension:0.1},
                {label:`Forecast (${method})`, data:forecastData, borderColor:'#f59e0b', borderDash:[5,5], pointRadius:0, tension:0.1}
            ]
        },
        options: { 
            responsive:true, maintainAspectRatio:false, 
            interaction: { intersect: false, mode: 'index' },
            scales:{ 
                y:{
                    min:0,
                    max:100,
                    title: {
                        display: true,
                        text: 'Progress (%)',
                        font: { size: 12, weight: 'bold' }
                    }
                }, 
                x:{ 
                    ticks:{
                        autoSkip: false,
                        maxRotation: 0,
                        minRotation: 0,
                        callback: function(value, index, values) {
                            const date = new Date(this.getLabelForValue(value));
                            const day = date.getDate();
                            if (day === 1) {
                                return date.toLocaleDateString('en-GB', { month: 'short', year: '2-digit' });
                            }
                            return null;
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const d = new Date(context[0].label);
                            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                        }
                    }
                }
            }
        }
    });

    renderForecastAnalysis(method, currentAct, currentPln, spi, end, today);
}

function renderForecastAnalysis(method, act, pln, spi, end, today) {
    let html = `<strong>Method: ${method.toUpperCase()}</strong><br><hr>`;
    const remaining = 100 - act;
    
    if (method === 'evm') {
        html += `‚Ä¢ Schedule Performance Index (SPI): <strong>${spi.toFixed(2)}</strong><br>`;
        html += `‚Ä¢ Status: ${spi < 1 ? '‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ú‡∏ô' : '‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ú‡∏ô'}<br>`;
        const estDays = (remaining / ((act / ((today - new Date(document.getElementById('projectStartDate').value)) / 86400000))));
        const estFinish = new Date(today.getTime() + estDays * 86400000);
        html += `‚Ä¢ Estimated Finish: <strong>${estFinish.toLocaleDateString('th-TH')}</strong>`;
    } else if (method === 'bottomup') {
        html += `‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞ Zone ‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å Cost<br>`;
        html += `‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`;
    } else {
        const factor = method === 'optimistic' ? 1.2 : (method === 'pessimistic' ? 0.7 : 1.0);
        html += `‚Ä¢ Scenario Factor: <strong>x${factor}</strong> ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô<br>`;
        html += `‚Ä¢ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå`;
    }

    document.getElementById('forecastContent').innerHTML = html;
    const riskEl = document.getElementById('riskContent');
    if(act < pln * 0.8) riskEl.innerHTML = `<span class="risk-high">üö© Critical Delay: ‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ú‡∏ô > 20%</span>`;
    else if(act < pln) riskEl.innerHTML = `<span class="risk-med">‚ö†Ô∏è Warning: ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤</span>`;
    else riskEl.innerHTML = `<span class="risk-low">‚úÖ On Track: ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô</span>`;
}

function updateZoneCost(id, val) {
    const ws = getActiveWS();
    const z = ws.zones.find(x => x.id === id);
    z.cost = parseFloat(val.replace(/,/g, '')) || 0;
    saveAll();
}
function updateZoneStatus(id, val) {
    const ws = getActiveWS();
    const z = ws.zones.find(x => x.id === id);
    z.status = val;
    if (val === "Completed") z.progress = 100;
    if (val === "Not Started") z.progress = 0;
    saveAll();
}
function updateZoneProgress(id, val) {
    const ws = getActiveWS();
    const z = ws.zones.find(x => x.id === id);
    z.progress = Math.min(100, Math.max(0, parseFloat(val) || 0));
    saveAll();
}
function updateZoneDate(id, field, val) {
    const ws = getActiveWS();
    const z = ws.zones.find(x => x.id === id);
    z[field] = val;
    saveAll();
}
function renameZone(id) {
    const ws = getActiveWS();
    const z = ws.zones.find(x => x.id === id);
    const n = prompt("New Name:", z.name);
    if (n) { z.name = n; saveAll(); }
}
async function deleteZone(id) {
    if (!confirm("Delete zone?")) return;
    const ws = getActiveWS();
    const z = ws.zones.find(x => x.id === id);
    if(z && z.photos) {
        z.photos.forEach(async pid => { if(pid.startsWith('http')) await storageHelper.deleteImage(pid); });
    }
    ws.zones = ws.zones.filter(z => z.id !== id);
    saveAll();
}

function triggerPhoto(id) {
    selectedZoneId = id;
    const input = document.createElement('input');
    input.type = 'file'; 
    input.accept = 'image/*';
    input.multiple = true; 
    input.onchange = async (e) => {
        const files = Array.from(e.target.files); 
        const ws = getActiveWS();
        const z = ws.zones.find(x => x.id === id);
        
        // Disable button visually if needed, but for now just process
        for (let file of files) {
            const reader = new FileReader();
            reader.onload = async () => {
                const compressed = await compressImage(reader.result, 800, 0.7);
                // Modified to include proper timestamp ID for comparison filtering
                const timestamp = Date.now();
                // We use timestamp in filename to track "New" status in compare modal
                const fileName = `photo_${timestamp}_${Math.random().toString(36).substr(2, 5)}.jpg`;
                const url = await storageHelper.uploadImage(compressed, 'photos/' + fileName);
                
                if(!z.photos) z.photos = [];
                // Store the full URL
                z.photos.push(url);
                
                saveAll();
                if (selectedZoneId === id) selectZone(id);
            };
            reader.readAsDataURL(file);
        }
    };
    input.click();
}

async function selectZone(id) {
    selectedZoneId = id;
    const ws = getActiveWS();
    const z = ws.zones.find(x => x.id === id);
    if (!z) return;
    document.getElementById('zoneDetail').style.display = 'block';
    document.getElementById('zdName').innerText = z.name;
    document.getElementById('zdStatus').innerText = z.status;
    document.getElementById('zdProgress').innerText = z.progress + "%";
    document.getElementById('zdCost').innerText = (z.cost || 0).toLocaleString();
    const photoWrap = document.getElementById('zdPhotos');
    photoWrap.innerHTML = 'Loading photos...';
    
    // Clear array
    while(photoWrap.firstChild) photoWrap.removeChild(photoWrap.firstChild);
    
    if (z.photos && z.photos.length) {
        z.photos.forEach(imgSrc => {
            const div = document.createElement('div');
            div.className = 'photo-item';
            const img = document.createElement('img');
            img.src = imgSrc; // Direct URL
            img.onclick = () => { document.getElementById('imgModal').style.display="block"; document.getElementById('imgModalSrc').src=imgSrc; };
            div.appendChild(img);
            
            // Add Delete Button
            const delBtn = document.createElement('span');
            delBtn.className = 'btn-del-photo';
            delBtn.innerText = 'x';
            delBtn.onclick = async (e) => {
                e.stopPropagation();
                if(confirm('Delete photo?')) {
                    await storageHelper.deleteImage(imgSrc);
                    z.photos = z.photos.filter(p => p !== imgSrc);
                    saveAll();
                    selectZone(id);
                }
            };
            div.appendChild(delBtn);

            photoWrap.appendChild(div);
        });
    } else {
        photoWrap.innerHTML = 'No photos';
    }
}

function closeZoneDetail() { document.getElementById('zoneDetail').style.display = 'none'; }

// --- New Feature: Fetch Weather ---
async function fetchWeather() {
    try {
        // Lat/Lon for Bangkok (Default)
        const lat = 13.7563;
        const lon = 100.5018;
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&timezone=Asia%2FBangkok`);
        const data = await res.json();
        if(data.current) {
            currentWeather.temp = data.current.temperature_2m;
            currentWeather.code = data.current.weather_code;
            
            // Map code to emoji
            const code = currentWeather.code;
            let icon = '‚òÅÔ∏è';
            if(code === 0) icon = '‚òÄÔ∏è';
            else if(code <= 3) icon = '‚õÖ';
            else if(code <= 48) icon = 'üå´Ô∏è';
            else if(code <= 67) icon = 'üåßÔ∏è';
            else if(code <= 99) icon = '‚õàÔ∏è';
            
            document.getElementById('weatherIcon').innerText = icon;
            document.getElementById('weatherTemp').innerText = currentWeather.temp + '¬∞C';
        }
    } catch(e) {
        console.error("Weather fetch failed", e);
    }
}

async function saveDailyProgress() {
    const date = document.getElementById('historyDateSelector').value;
    if (!date) return;
    
    // Ensure weather is up to date before saving
    await fetchWeather();

    let snapshot = {};
    workspaces.forEach(ws => ws.zones.forEach(z => { snapshot[z.id] = z.progress; }));
    
    // Store Data + Weather
    dailyHistory[date] = {
        data: snapshot,
        weather: { ...currentWeather }
    };

    saveAll();
    document.getElementById('historyStatus').innerText = "‚úì Saved";
}

function clearDailyHistory() {
    if (confirm("‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Cloud)?")) {
        dailyHistory = {}; 
        saveAll();
    }
}

function toggleActionMenu(e, id) {
    e.stopPropagation();
    document.querySelectorAll('.action-dropdown').forEach(m => { if (m.id !== 'menu-' + id) m.style.display = 'none'; });
    const menu = document.getElementById('menu-' + id);
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

function exportExcel() {
    const wb = XLSX.utils.book_new();
    workspaces.forEach(ws => {
        const data = ws.zones.map(z => ({ "Name": z.name, "Cost": z.cost, "Status": z.status, "Progress": z.progress, "Start": z.startDate, "Due": z.dueDate }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), ws.name.substring(0, 31));
    });
    XLSX.writeFile(wb, `Report_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// --- New Feature: Export PDF (Daily Report) ---
async function exportDailyReportPDF() {
    const btn = document.querySelector('button.purple');
    const originalText = btn.innerText;
    btn.innerText = "Generating...";

    // 1. Prepare Data
    document.getElementById('pdf-project-name').innerText = document.getElementById('projectName').value || "Project Name";
    const todayStr = new Date().toLocaleDateString('th-TH', { dateStyle: 'full' });
    document.getElementById('pdf-date').innerText = "Date: " + todayStr;
    document.getElementById('pdf-weather').innerText = `Weather: ${document.getElementById('weatherIcon').innerText} ${document.getElementById('weatherTemp').innerText}`;
    
    document.getElementById('pdf-plan').innerText = document.getElementById('sumPlan').innerText;
    document.getElementById('pdf-actual').innerText = document.getElementById('sumActual').innerText;
    document.getElementById('pdf-status').innerHTML = document.getElementById('summaryStatus').innerText;
    
    // 2. Populate Table
    const tbody = document.getElementById('pdf-table-body');
    tbody.innerHTML = "";
    workspaces.forEach(ws => {
        // Header Row for Sheet
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = `<td colspan="4" style="background:#f8fafc; font-weight:bold; color:#334155; padding:8px; border:1px solid #cbd5e1;">${ws.name}</td>`;
        tbody.appendChild(headerRow);
        
        ws.zones.forEach(z => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding:6px; border:1px solid #cbd5e1;">${z.name}</td>
                <td style="padding:6px; border:1px solid #cbd5e1; text-align:center;">${z.status}</td>
                <td style="padding:6px; border:1px solid #cbd5e1; text-align:center;">${z.progress}%</td>
                <td style="padding:6px; border:1px solid #cbd5e1;">${z.progress < calcPlan(z) ? 'Delay' : 'OK'}</td>
            `;
            tbody.appendChild(tr);
        });
    });

    // 3. Render and Save
    try {
        const element = document.getElementById('pdf-print-container');
        // Temporarily make it visible in DOM but off-screen (css handles this)
        
        const canvas = await html2canvas(element, { scale: 2 });
        const imgData = canvas.toDataURL('image/png');
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`DailyReport_${new Date().toISOString().slice(0,10)}.pdf`);
        
    } catch (e) {
        console.error("PDF Gen Error", e);
        alert("Error generating PDF");
    } finally {
        btn.innerText = originalText;
    }
}

// --- New Feature: Comparison System Functions ---
function openCompareModal() {
    const modal = document.getElementById('compareModal');
    const selA = document.getElementById('compareDateA');
    const selB = document.getElementById('compareDateB');
    
    // Populate Dropdowns
    const dates = Object.keys(dailyHistory).sort();
    let opts = '<option value="">Select Date...</option>';
    dates.forEach(d => opts += `<option value="${d}">${d}</option>`);
    
    selA.innerHTML = opts;
    selB.innerHTML = opts + `<option value="CURRENT" selected>Current (Live)</option>`;
    
    if(dates.length > 0) selA.value = dates[dates.length - 1]; // Select last saved by default
    
    renderComparison();
    modal.style.display = 'block';
}

async function renderComparison() {
    const dateA = document.getElementById('compareDateA').value;
    const dateB = document.getElementById('compareDateB').value;
    const tbody = document.getElementById('compareTableBody');
    tbody.innerHTML = '';

    if (!dateA || !dateB) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#aaa;">Please select both dates to compare.</td></tr>`;
        return;
    }

    // Helper to get data (support old format)
    const getHist = (d) => {
        if (d === 'CURRENT') {
            let snap = {};
            workspaces.forEach(ws => ws.zones.forEach(z => snap[z.id] = z.progress));
            return { data: snap, weather: { ...currentWeather } };
        }
        if (!dailyHistory[d]) return { data: {}, weather: {} };
        return dailyHistory[d].data ? dailyHistory[d] : { data: dailyHistory[d], weather: {} }; // compat check
    };

    const dataA = getHist(dateA);
    const dataB = getHist(dateB);

    // Calculate Totals
    let totalCost = 0, wSumA = 0, wSumB = 0;
    workspaces.forEach(ws => ws.zones.forEach(z => {
        const cost = parseFloat(z.cost) || 0;
        totalCost += cost;
        wSumA += ((dataA.data[z.id] || 0) * cost);
        wSumB += ((dataB.data[z.id] || 0) * cost);
    }));

    const pctA = totalCost > 0 ? (wSumA / totalCost) : 0;
    const pctB = totalCost > 0 ? (wSumB / totalCost) : 0;

    // Render Top Stats
    document.getElementById('compValA').innerText = pctA.toFixed(2) + '%';
    document.getElementById('compValB').innerText = pctB.toFixed(2) + '%';
    
    // Render Weather Stats
    const renderWeather = (w) => (w && w.temp) ? `üå°Ô∏è ${w.temp}¬∞C (Code: ${w.code})` : 'No weather data';
    document.getElementById('compWeatherA').innerText = renderWeather(dataA.weather);
    document.getElementById('compWeatherB').innerText = renderWeather(dataB.weather);

    // Render Table Rows (Zone diff + New Photos)
    // photo_TIMESTAMP_....
    const timeA = new Date(dateA).getTime();
    const timeB = (dateB === 'CURRENT') ? Date.now() : new Date(dateB).getTime() + 86400000; // End of day B

    for (const ws of workspaces) {
        for (const z of ws.zones) {
            const pA = dataA.data[z.id] || 0;
            const pB = dataB.data[z.id] || 0;
            const diff = pB - pA;
            
            // Filter relevant photos
            let photoHtml = '';
            if (z.photos && z.photos.length > 0) {
                const relevantPhotos = z.photos.filter(pid => {
                    // Extract timestamp from URL if we used our naming convention
                    // Format: .../photos%2Fphoto_TIMESTAMP_RANDOM.jpg...
                    // Decoding safe extraction:
                    const match = pid.match(/photo_(\d+)_/);
                    if (match && match[1]) {
                         const ts = parseInt(match[1]);
                         return ts > timeA && ts <= timeB;
                    }
                    return false;
                });

                if (relevantPhotos.length > 0) {
                    photoHtml = '<div class="photo-grid-small">';
                    for (const pid of relevantPhotos) {
                         photoHtml += `<img src="${pid}" onclick="document.getElementById('imgModal').style.display='block';document.getElementById('imgModalSrc').src='${pid}'">`;
                    }
                    photoHtml += '</div><span class="new-badge">New</span>';
                } else {
                    photoHtml = '<span style="color:#ccc">-</span>';
                }
            }

            const diffClass = diff > 0 ? 'diff-val positive' : (diff < 0 ? 'diff-val negative' : 'diff-val');
            const diffText = diff > 0 ? `+${diff.toFixed(2)}%` : `${diff.toFixed(2)}%`;

            const row = `
                <tr>
                    <td style="font-weight:600;">${z.name}</td>
                    <td style="text-align:center;">${pA}%</td>
                    <td style="text-align:center;">${pB}%</td>
                    <td style="text-align:center; font-weight:bold;" class="${diffClass}">${diffText}</td>
                    <td>${photoHtml}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        }
    }
}

async function initUI() {
    renderTabs();
    await initLayout();
    loadZones();
}

window.onload = () => {
    document.getElementById('historyDateSelector').value = new Date().toISOString().slice(0, 10);
    setInterval(() => { document.getElementById('currentTime').innerText = 'Current : ' + new Date().toLocaleString(); }, 1000);
    
    // Initial fetches
    fetchWeather();
    initFirebase(); // Starts the app and loads data from cloud
};

window.onclick = (event) => {
    document.querySelectorAll('.action-dropdown').forEach(m => m.style.display = 'none');
    if (event.target.className === 'analysis-modal') event.target.style.display = "none";
};
</script>

</body>
</html>
